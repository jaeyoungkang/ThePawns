<!DOCTYPE html>
<html>
<head>
    <script src="http://code.jquery.com/jquery-latest.js"></script>

    <style media="screen">
    .container {
    position: relative;
    width: 80px;
    height: 80px;
    }

    button{
    background:white;
    padding:0px 0px 0px 0px;
    margin: 0px 0px 0px 0px;
    }

    .pawn{
    position: absolute;
    top: 20px;
    left: 10px;
    width: 60px;
    height: 60px;
    }

    .observer{
    position: absolute;
    top: 0px;
    left: 0px;
    width: 35px;
    height: 35px;
    }

    .observerB{
    position: absolute;
    top: 0px;
    left: 45px;
    width: 35px;
    height: 35px;
    background:white;
    }
    </style>
</head>

<body onload="startBattle()">
<script type="text/javascript">
var BLUE_TEAM = 0;
var RED_TEAM = 1;
var VIEW_MODE = BLUE_TEAM;

function GAME_OBJECT (_type, _index, _color, _selected_color) {
    this.type = _type;
    this.index = parseInt(_index);
    this.color = _color;
    this.normal_color = _color;
    this.selected_color = _selected_color;

    this.updateIndex = function(_index) {
        this.index = parseInt(_index);
    };

    this.setSelect = function(value) {
        if(value == true) {
            this.color = this.selected_color;
        } else {
            this.color = this.normal_color;
        }
    }
};

var pawn_blue = null;
var pawn_red = null;
var observer_blue = null;
var observer_red = null;
var pawn_selected = null;
var postions = [];

function InitObjects() {
    pawn_blue = new GAME_OBJECT('P', postions[0], 'blue', 'lightBlue');
    observer_blue = new GAME_OBJECT('O', postions[1], 'blue', 'lightBlue');

    pawn_red = new GAME_OBJECT('P', postions[2], 'red', 'pink');
    observer_red = new GAME_OBJECT('O', postions[3], 'red', 'pink');
    draw();
}

function startBattle() {
    getInfo();

    $('.observer').click(function(elmnt){
        console.log("Observer was clicked - " + elmnt.target.value);
        var index = parseInt(elmnt.target.value);
        controll_pawns(index, "O");
    });

    $('.pawn').click(function(elmnt){
        console.log("Pawn was clicked - " + elmnt.target.value);
        var index = parseInt(elmnt.target.value);
        controll_pawns(index, "P");
    });
}

function controll_pawns(pawn_index, pawn_type) {
    if(pawn_selected != null && pawn_selected.type != pawn_type) {
        pawn_selected.setSelect(false);
        pawn_selected = null;
    }

    if(pawn_selected != null) {
        if(validatePostionToMove(pawn_index)) {
            pawn_selected.updateIndex(pawn_index);
         }
     }

    if(pawn_type == "O") {
        if(observer_blue.index == pawn_index) {
            pawn_selected = observer_blue;
        } else if(observer_red.index == pawn_index) {
            pawn_selected = observer_red;
        }
    } else if(pawn_type == "P") {
        if(pawn_blue.index == pawn_index) {
            pawn_selected = pawn_blue;
        } else if(pawn_red.index == pawn_index) {
            pawn_selected = pawn_red;
        }
    }

    if(pawn_selected != null) {
        pawn_selected.setSelect(true);
    }

    draw();
    postInfo();
}

function validatePostionToMove(index) {
    if( pawn_selected.index + 1== index ||
        pawn_selected.index + 10== index ||
        pawn_selected.index - 1== index ||
        pawn_selected.index - 10== index)
        return true;

    return false;
}

function draw() {
    clearBoard();

    if(pawn_blue.index != -1) {
        btnId = "#" + pawn_blue.index.toString() + "_" + pawn_blue.type;
        $(btnId).css( {"border-radius":"50%", "background":pawn_blue.color} );
    }
    if(observer_blue.index != -1) {
        btnId = "#" + observer_blue.index.toString()+ "_" + observer_blue.type;
        $(btnId).css( {"border-radius":"50%", "background":observer_blue.color} );
    }

    if(pawn_red.index != -1) {
        btnId = "#" + pawn_red.index.toString() + "_" + pawn_red.type;
        $(btnId).css( {"border-radius":"50%", "background":pawn_red.color} );
    }
    if(observer_red.index != -1) {
        btnId = "#" + observer_red.index.toString() + "_" + observer_red.type;
        $(btnId).css( {"border-radius":"50%", "background":observer_red.color} );
     }

}

function clearBoard() {
    for(var i=0; i<3; i++) {
        for(var j=0; j<3; j++) {
            if(i==0) btnId = "#" + j.toString() + "_O";
            else  btnId = "#" + i.toString() + j.toString() + "_O";
            $(btnId).css( {"border-radius":"0%", "background":"white"} );
            if(i==0) btnId = "#" + j.toString() + "_P";
            else  btnId = "#" + i.toString() + j.toString() + "_P";
            $(btnId).css( {"border-radius":"0%", "background":"white"} );
        }
    }
}

var SERVER_DOMAIN = 'http://127.0.0.1:8000/';
function makeposInfo() {
    var posInfo = ""
    if(pawn_blue.index != -1) posInfo += pawn_blue.index.toString();
    if(observer_blue.index != -1) posInfo += " " + observer_blue.index.toString();
    if(pawn_red.index != -1) posInfo += " " + pawn_red.index.toString();
    if(observer_red.index != -1) posInfo +=  " " + observer_red.index.toString();

    return posInfo;
}

function updateObjects() {
    pawn_blue.updateIndex(-1);
    observer_blue.updateIndex(-1);
    pawn_red.updateIndex(-1);
    observer_red.updateIndex(-1);

    pawn_blue.updateIndex(postions[0]);
    observer_blue.updateIndex(postions[1]);
    if(postions.length > 2) pawn_red.updateIndex(postions[2]);
    if(postions.length > 3) observer_red.updateIndex(postions[3]);
    draw();
}

function postInfo() {
    var postions = makeposInfo();
    $.post(SERVER_DOMAIN + 'post_info/map/', {info:postions}, function(data) {
        console.log('posted ' + postions);
        updateInfo();
    })
}

function updateInfo() {
    $.post(SERVER_DOMAIN + 'get_info/map/', function(data) {
        postions = data.split(' ').map(function(n){return parseInt(n);})
        console.log('updated ' + data);
        updateObjects();
    })
}

function getInfo() {
    $.post(SERVER_DOMAIN + 'get_info/map/', function(data) {
        console.log('get initial Info ' + data);
        postions = data.split(' ').map(function(n){return parseInt(n);})
        InitObjects();
    })
}

function drawObservers() {
  if(observers.length == 0) return;

  btnId = "#" + observers[0].index.toString()+ "_O";
  $(btnId).css( {"border-radius":"50%", "background":observers[0].color} );
}
</script>
<table>
    <tr>
    <td>
      <div class="container">
        <button id="0_P" class="button pawn" value = '0' >00</button>
        <button id="0_O" class="button observer" value = '0' >00</button>
      </div>
    </td>
    <td>
      <div class="container">
        <button id="1_P" class="button pawn" value = '1' >01</button>
        <button id="1_O" class="button observer" value = '1' >01</button>
      </div>
    </td>
    <td>
      <div class="container">
        <button id="2_P" class="button pawn" value = '2' >02</button>
        <button id="2_O" class="button observer" value = '2' >02</button>
      </div>
    </td>
    </tr>
    <tr>
    <td>
      <div class="container">
        <button id="10_P" class="button pawn" value = '10'>10</button>
        <button id="10_O" class="button observer"value = '10'>10</button>
      </div>
    </td>
    <td>
      <div class="container">
        <button id="11_P" class="button pawn" value = '11'>11</button>
        <button id="11_O" class="button observer" value = '11'>11</button>
      </div>
    </td>
    <td>
      <div class="container">
        <button id="12_P" class="button pawn" value = '12'>12</button>
        <button id="12_O" class="button observer" value = '12'>12</button>
      </div>
    </td>
    </tr>
    <tr>
    <td>
      <div class="container">
        <button id="20_P" class="button pawn" value = '20'>20</button>
        <button id="20_O" class="button observer" value = '20'>20</button>
      </div>
    </td>
    <td>
      <div class="container">
        <button id="21_P" class="button pawn" value = '21'>21</button>
        <button id="21_O" class="button observer" value = '21'>21</button>
      </div>
    </td>
    <td>
      <div class="container">
        <button id="22_P" class="button pawn" value = '22'>22</button>
        <button id="22_O" class="button observer" value = '22'>22</button>
      </div>
    </td>
    </tr>
</table>
</body>
</html>